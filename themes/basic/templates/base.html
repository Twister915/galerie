<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ site.title }}{% endblock title %}</title>
    <link rel="stylesheet" href="{{ static(path='style.css') }}">
</head>
<body>
    <header>
        <a href="/" class="site-title">{{ site.title }}</a>
        {% if languages | length > 1 %}
        <div class="lang-picker">
            {% for l in languages %}
            <button data-lang="{{ l.code }}">{{ l.name }}</button>
            {% endfor %}
        </div>
        {% endif %}
    </header>
    <main>
        {% block content %}{% endblock content %}
    </main>

    <!-- i18n data -->
    <script id="i18n-data" type="application/json">
    {{ i18n | json_encode() | safe }}
    </script>
    <script>
    (function() {
        var i18n = JSON.parse(document.getElementById('i18n-data').textContent);
        var defaultLang = '{{ default_lang }}';

        function detectLang() {
            var langs = navigator.languages || [navigator.language];
            for (var i = 0; i < langs.length; i++) {
                var browserLang = langs[i];
                var normalized = browserLang.replace('-', '_');
                if (i18n[normalized]) return normalized;

                var prefix = browserLang.split('-')[0];
                for (var lang in i18n) {
                    if (lang.indexOf(prefix) === 0) return lang;
                }
            }
            return defaultLang;
        }

        function getLang() {
            return localStorage.getItem('lang') || detectLang();
        }

        function setLang(lang) {
            localStorage.setItem('lang', lang);
            applyTranslations();
            updatePicker();
        }

        function t(key) {
            var lang = getLang();
            return (i18n[lang] && i18n[lang][key]) || (i18n[defaultLang] && i18n[defaultLang][key]) || key;
        }

        function applyTranslations() {
            var elements = document.querySelectorAll('[data-i18n]');
            for (var i = 0; i < elements.length; i++) {
                elements[i].textContent = t(elements[i].getAttribute('data-i18n'));
            }
            document.documentElement.lang = getLang();
        }

        function updatePicker() {
            var current = getLang();
            var buttons = document.querySelectorAll('.lang-picker button');
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                if (btn.getAttribute('data-lang') === current) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        // Init
        var buttons = document.querySelectorAll('.lang-picker button');
        for (var i = 0; i < buttons.length; i++) {
            (function(btn) {
                btn.addEventListener('click', function() {
                    setLang(btn.getAttribute('data-lang'));
                });
            })(buttons[i]);
        }
        applyTranslations();
        updatePicker();
    })();
    </script>
</body>
</html>
