<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ site.title }}{% endblock title %}</title>
    <link rel="stylesheet" href="{{ static(path='style.css') }}">
</head>
<body>
    <header>
        <a href="/" class="site-title">{{ site.title }}</a>
        {% if languages | length > 1 %}
        <div class="lang-picker">
            {% for l in languages %}
            <button data-lang="{{ l.code }}">{{ l.name }}</button>
            {% endfor %}
        </div>
        {% endif %}
    </header>
    <main>
        {% block content %}{% endblock content %}
    </main>

    <footer class="site-footer">
        <span data-i18n="footer.built_with">Built with</span>
        <a href="https://github.com/Twister915/galerie" target="_blank" rel="noopener">galerie</a>
        <span class="version">{{ site.version }}</span>
        <span data-i18n="footer.built_with_suffix"></span>
    </footer>

    <!-- Data URLs for async loading -->
    <script>
    var I18N_URLS = {{ data_urls.i18n | json_encode() | safe }};
    var I18N_CONFIG = {
        languages: {{ languages | json_encode() | safe }},
        default: "{{ default_lang }}"
    };
    </script>
    <script>
    (function() {
        var i18nData = {};  // Map of lang code -> translations

        function getI18nCacheKey(lang) {
            return 'galerie-i18n-' + I18N_URLS[lang];
        }

        function loadI18nLang(lang, callback) {
            var url = I18N_URLS[lang];
            if (!url) {
                callback();
                return;
            }

            var cacheKey = getI18nCacheKey(lang);
            var cached = null;
            try { cached = localStorage.getItem(cacheKey); } catch(e) {}

            if (cached) {
                try {
                    i18nData[lang] = JSON.parse(cached);
                    callback();
                    return;
                } catch(e) {}
            }

            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    i18nData[lang] = data;
                    try { localStorage.setItem(cacheKey, JSON.stringify(data)); } catch(e) {}
                    callback();
                })
                .catch(function(err) {
                    console.error('Failed to load i18n for ' + lang + ':', err);
                    callback();
                });
        }

        function detectLangFromBrowser() {
            var langs = navigator.languages || [navigator.language];
            for (var i = 0; i < langs.length; i++) {
                var browserLang = langs[i];
                var normalized = browserLang.replace('-', '_');
                if (I18N_URLS[normalized]) return normalized;

                var prefix = browserLang.split('-')[0];
                for (var lang in I18N_URLS) {
                    if (lang.indexOf(prefix) === 0) return lang;
                }
            }
            return I18N_CONFIG.default;
        }

        function getLang() {
            return localStorage.getItem('lang') || detectLangFromBrowser();
        }

        function setLang(lang) {
            if (!i18nData[lang]) {
                loadI18nLang(lang, function() {
                    applyLangChange(lang);
                });
            } else {
                applyLangChange(lang);
            }
        }

        function applyLangChange(lang) {
            localStorage.setItem('lang', lang);
            applyTranslations();
            updatePicker();
        }

        function t(key) {
            var lang = getLang();
            if (i18nData[lang] && typeof i18nData[lang][key] === 'string') {
                return i18nData[lang][key];
            }
            if (i18nData[I18N_CONFIG.default] && typeof i18nData[I18N_CONFIG.default][key] === 'string') {
                return i18nData[I18N_CONFIG.default][key];
            }
            return key;
        }

        function applyTranslations() {
            var elements = document.querySelectorAll('[data-i18n]');
            for (var i = 0; i < elements.length; i++) {
                elements[i].textContent = t(elements[i].getAttribute('data-i18n'));
            }
            document.documentElement.lang = getLang();
        }

        function updatePicker() {
            var current = getLang();
            var buttons = document.querySelectorAll('.lang-picker button');
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                if (btn.getAttribute('data-lang') === current) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        // Init
        var buttons = document.querySelectorAll('.lang-picker button');
        for (var i = 0; i < buttons.length; i++) {
            (function(btn) {
                btn.addEventListener('click', function() {
                    setLang(btn.getAttribute('data-lang'));
                });
            })(buttons[i]);
        }

        // Load current language and default language, then apply
        var currentLang = getLang();
        var pending = 1;
        function done() {
            pending--;
            if (pending === 0) {
                applyTranslations();
                updatePicker();
            }
        }

        loadI18nLang(currentLang, done);
        if (currentLang !== I18N_CONFIG.default) {
            pending++;
            loadI18nLang(I18N_CONFIG.default, done);
        }
    })();
    </script>
</body>
</html>
